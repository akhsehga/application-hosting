

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>            Logging on IOS-XR guest OS with rsyslog and Elastic stack      IOS XR Application Hosting @xrdocs      </title>







<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="IOS XR Application Hosting @xrdocs">
<meta property="og:title" content="Logging on IOS-XR guest OS with rsyslog and Elastic stack">


  <link rel="canonical" href="http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/">
  <meta property="og:url" content="http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/">



  <meta property="og:description" content="In this tutorial we are going to cover how to configure logging solution on IOS-XR guest OS and apply it on Elastic stack.">



  <meta name="twitter:site" content="@xrdocs">
  <meta name="twitter:title" content="Logging on IOS-XR guest OS with rsyslog and Elastic stack">
  <meta name="twitter:description" content="In this tutorial we are going to cover how to configure logging solution on IOS-XR guest OS and apply it on Elastic stack.">
  <meta name="twitter:url" content="http://0.0.0.0:4000/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="http://0.0.0.0:4000/application-hosting/images/app-hosting-xrdocs.jpg">
    
  

  
    <meta name="twitter:creator" content="@mike_korshunov">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2018-05-25T20:33:00+00:00">
  
    <link rel="next" href="http://0.0.0.0:4000/application-hosting/tutorials/2018-08-06-comprehensive-guide-to-ansible-on-ios-xr/" title="Comprehensive guide to Ansible on IOS-XR">
  
  
    <link rel="prev" href="http://0.0.0.0:4000/application-hosting/tutorials/2017-04-12-on-box-telemetry-running-pipeline-and-kafka-on-ios-xr/" title="On-box Telemetry: Running  Pipeline and Kafka on IOS-XR (6.2.1+)">
  



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://0.0.0.0:4000/application-hosting",
      "logo": "http://0.0.0.0:4000/application-hosting/images/app-hosting-xrdocs.jpg"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "person",
      "name" : "Cisco Systems Inc",
      "url" : "http://0.0.0.0:4000/application-hosting",
      "sameAs" : ["https://twitter.com/xrdocs"]
    }
  </script>






<!-- end SEO -->

<link href="http://0.0.0.0:4000/application-hosting/feed.xml" type="application/atom+xml" rel="alternate" title="IOS XR Application Hosting @xrdocs Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="jgRKKm6B9FwJJPXxpmc0-EP3D0Mh8JHXaJqoYIGj1ek" />

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<script>
if (!(window.location.host.startsWith("127.0.0.1") || window.location.host.startsWith("localhost")) && (window.location.host.substr(-3) == '.io') && (window.location.protocol != "https:"))
    window.location.protocol = "https";
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/application-hosting/assets/css/main.css">
<meta http-equiv="cleartype" content="on">
<style>
.underline-on-hover:hover {
    text-decoration: underline;
}
.searchForm{
      border-radius:5px;
      -moz-border-radius:5px;
      -webkit-border-radius:5px;
      width: 900px;
   }
#search_results{
      display: table; margin:0 auto;
   }
</style>
</style>

    

<!-- start custom head snippets -->

<link href="http://0.0.0.0:4000/application-hosting/assets/css/lity.min.css" rel="stylesheet">
<link href="http://0.0.0.0:4000/application-hosting/assets/css/cisco-sans.min.css" rel="stylesheet">
<link href="http://0.0.0.0:4000/application-hosting/assets/css/material-scrolltop.css" rel="stylesheet">

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://0.0.0.0:4000/application-hosting/images/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="http://0.0.0.0:4000/application-hosting/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="http://0.0.0.0:4000/application-hosting/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="http://0.0.0.0:4000/application-hosting/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="http://0.0.0.0:4000/application-hosting/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="http://0.0.0.0:4000/application-hosting/images/favicon-128.png" sizes="128x128" />
<link rel="shortcut icon" href="http://0.0.0.0:4000/application-hosting/images/favicon_cisco.ico" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="http://0.0.0.0:4000/application-hosting/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="http://0.0.0.0:4000/application-hosting/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="http://0.0.0.0:4000/application-hosting/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="http://0.0.0.0:4000/application-hosting/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="http://0.0.0.0:4000/application-hosting/images/mstile-310x310.png" />


<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu" style="padding-left:2em;">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <img src="http://0.0.0.0:4000/application-hosting/images/xrdocs_logo.png" width="45px" height="45px" alt="xrdocs logo" style="float:left;">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://0.0.0.0:4000">@xrdocs</a></li>
          <li class="masthead__menu-item"><a href="http://0.0.0.0:4000/application-hosting/">App-Hosting</a></li>
          
            
            
                
                    <li class="masthead__menu-item"><a href="http://0.0.0.0:4000/application-hosting/blogs/">Blogs</a></li>
                
            


          
            
            
                
                    <li class="masthead__menu-item greedy-nav-active"><a href="http://0.0.0.0:4000/application-hosting/tutorials/">Tutorials</a></li>
                
            


          
            
            
                
                    <li class="masthead__menu-item"><a href="http://0.0.0.0:4000/application-hosting/search">Search <i class="fa fa-search" aria-hidden="true"></i></a></li>
                
            


          
            
            
                
                    <li class="masthead__menu-item"><a href="http://0.0.0.0:4000/application-hosting/tags/">Tags</a></li>
                
            


          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    



<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://0.0.0.0:4000/application-hosting/images/avatars/Mike_pic.jpg" class="author__avatar" alt="Mike Korshunov">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Mike Korshunov</h3>
    <p class="author__bio">Technical Marketing Engineer, Cisco</p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
      
      
        <li><a href="mailto:mkorshun@cisco.com"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
      
      
      
        <li><a href="http://twitter.com/mike_korshunov"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
      
      
      
      
        <li><a href="http://linkedin.com/in/mkorshunov"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li>
      
      
      
      
      
      
        <li><a href="http://github.com/maikor"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>


  </div>
    <br><button class="btn"><a href="//pdfcrowd.com/url_to_pdf/" style="color:white">Save as PDF</a></button>

</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Logging on IOS-XR guest OS with rsyslog and Elastic stack">
    <meta itemprop="description" content="In this tutorial we are going to cover how to configure logging solution on IOS-XR guest OS and apply it on Elastic stack.">
    <meta itemprop="datePublished" content="May 25, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Logging on IOS-XR guest OS with rsyslog and Elastic stack
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  9 minutes read
</p>
          
        </header>
      

    
      
        





<div class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList" style="margin:0;padding:0;">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" style="margin:0;padding:0;">
          <a href="http://0.0.0.0:4000/application-hosting/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" style="margin:0;padding:0;">
          <a href="http://0.0.0.0:4000/application-hosting/tutorials" itemprop="item"><span itemprop="name">Tutorials</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current" style="margin:0;padding:0;">Logging on IOS-XR guest OS with rsyslog and Elastic stack </li>
      
    
  </ol>
</div>

      
    

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-table"></i> Logging on IOS-XR guest OS with rsyslog and Elastic stack</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#intro" id="markdown-toc-intro">Intro</a>    <ul>
      <li><a href="#requirements" id="markdown-toc-requirements">Requirements</a>        <ul>
          <li><a href="#steps-to-spin-up-vagrant-setup" id="markdown-toc-steps-to-spin-up-vagrant-setup">Steps to spin up Vagrant setup</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#rsyslog" id="markdown-toc-rsyslog">rsyslog</a>    <ul>
      <li><a href="#package-installation-on-ios-xr" id="markdown-toc-package-installation-on-ios-xr">Package installation on IOS-XR</a>        <ul>
          <li><a href="#scp-option" id="markdown-toc-scp-option">SCP option</a></li>
          <li><a href="#yum-installation-from-public-repo" id="markdown-toc-yum-installation-from-public-repo">YUM installation from public repo</a></li>
        </ul>
      </li>
      <li><a href="#filters" id="markdown-toc-filters">Filters</a></li>
    </ul>
  </li>
  <li><a href="#configuring-server-side" id="markdown-toc-configuring-server-side">Configuring server side</a>    <ul>
      <li><a href="#syslog-ng" id="markdown-toc-syslog-ng">syslog-ng</a></li>
      <li><a href="#elastic-stack" id="markdown-toc-elastic-stack">Elastic stack</a></li>
      <li><a href="#logrotate" id="markdown-toc-logrotate">logrotate</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

  </nav>
</aside>

<h1 id="intro">Intro</h1>

<p>Have you ever worried about logging in the IOS-XR Linux environment? With Linux adoption, we can align our techniques and operational flows with the server world. There should be as little as possible difference in operations.</p>

<p>In this tutorial, we are going to cover routers configuration to stream Syslog message and accept those messages on an Ubuntu machine with <a href="https://syslog-ng.com/">Syslog-ng</a> and <a href="https://elastic.co">Elastic stack</a>.</p>

<p><img src="/application-hosting/images/logging/logging-arch.png" alt="" />
<em>Figure 1 - Logging concepts</em></p>

<h2 id="requirements">Requirements</h2>

<p>You can run this tutorial on your computer using <a href="https://www.vagrantup.com/">Vagrant</a> and virtualization technologies. Topology consists of Ubuntu VM and IOS-XRv instance.</p>

<p>You will need following resources:</p>

<ul>
  <li>5 GB of RAM;</li>
  <li>2 vCPU;</li>
  <li>Virtualbox, Vagrant and git installed;</li>
  <li>IOS-XRv instance. Follow <a href="/application-hosting/tutorials/iosxr-vagrant-quickstart">this tutorial</a> to request it.</li>
</ul>

<h3 id="steps-to-spin-up-vagrant-setup">Steps to spin up Vagrant setup</h3>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
$<span style="background-color: #FFFF00">git clone https://github.com/Maikor/IOS-XR-logging-tutorial.git </span>
Cloning into 'IOS-XR-logging-tutorial'...
remote: Counting objects: 14, done.
remote: Compressing objects: 100% (12/12), done.
remote: Total 14 (delta 1), reused 8 (delta 0), pack-reused 0
Unpacking objects: 100% (14/14), done.
Checking connectivity... done.
$<span style="background-color: #FFFF00"> cd IOS-XR-logging-tutorial</span>
$<span style="background-color: #FFFF00"> vagrant up</span>

$<span style="background-color: #FFFF00"> vagrant port xr</span>
The forwarded ports for the machine are listed below. Please note that
these values may differ from values configured in the Vagrantfile if the
provider supports automatic port collision detection and resolution.

 <span style="background-color: #FFFF00">22 (guest) =&gt; 2223 (host)</span>
 57722 (guest) =&gt; 2200 (host)
 
# to access IOS-XR (password for access vagrant):
$<span style="background-color: #FFFF00"> ssh -p 2223 vagrant@127.0.0.1 </span>
Password:
RP/0/RP0/CPU0:xr#
# to access ubuntu
<span style="background-color: #FFFF00">vagrant ssh ubuntu</span>
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-127-generic x86_64)
vagrant@ubuntu-xenial:~$
</code>
</pre>
</div>

<h1 id="rsyslog">rsyslog</h1>

<p>What is rsyslog and why should we care?</p>

<p>rsyslog is the Rocket-fast SYStem for LOG processing.</p>

<p>It offers high-performance, excellent security features, and a modular design. While it started as regular syslogd, rsyslog has evolved into a kind of swiss army knife of logging, being able to accept inputs from a wide variety of sources, transform them, and output the results to a variety of destinations.</p>

<p>RSYSLOG can deliver over one million messages per second to local destinations when limited processing is applied (based on v7, December 2013). Even with remote destinations and more elaborate processing the performance is usually considered impressive. The crucial advantage over traditional syslog – the capability to send messages to remote receivers.</p>

<p>There are of course, several other advantages:</p>

<ul>
  <li>Multi-threading</li>
  <li>TCP, SSL, TLS, RELP</li>
  <li>MySQL, PostgreSQL, Oracle and more</li>
  <li>Filter any part of syslog message</li>
  <li>Fully configurable output format</li>
</ul>

<h2 id="package-installation-on-ios-xr">Package installation on IOS-XR</h2>

<p>By default, syslog is utilized in the IOS-XR Linux environment. We will replace it with rsyslog. To do it, we will need to get the package installed on the router.</p>

<p>There are two options to get rpm on the box:</p>
<ul>
  <li>SCP</li>
  <li>Installation via YUM</li>
</ul>

<h3 id="scp-option">SCP option</h3>

<p>If you are going to use SCP, you can grab package <a href="https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/">directly</a> and copy it to the router. Use yum with option <em>localonly</em> to proceed with the installation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Canonball:~]$ yum install localonly -y rsyslog-7.4.4-r0.0.core2_64.rpm
</code></pre></div></div>

<h3 id="yum-installation-from-public-repo">YUM installation from public repo</h3>

<p class="notice--info">If you want to use YUM and your router has external connectivity, you may setup a yum repository and install the package via yum. Based on your setup, few extra steps may be required, such as DNS configuration and setting proxy environment.</p>

<p>Let’s configure DNS servers on the router.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RP/0/RP0/CPU0:Canonball#conf t
Mon May 28 00:56:06.322 UTC
RP/0/RP0/CPU0:Canonball(config)#domain name-server 1.1.1.1
RP/0/RP0/CPU0:Canonball(config)#domain name-server 8.8.8.8
RP/0/RP0/CPU0:Canonball(config)#commit
Mon May 28 00:56:25.687 UTC
</code></pre></div></div>

<p>Once name-server applied in XR CLI config, it will be represented in XR Linux shell:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RP/0/RP0/CPU0:Canonball#bash
Mon May 28 00:57:19.519 UTC
[Canonball:~]$ cat /etc/resolv.conf
domain local
search local
nameserver 1.1.1.1
nameserver 8.8.8.8
</code></pre></div></div>

<p class="notice--info">If your device is behind a proxy, configure it in XR Linux shell:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Canonball:~]$ export http_proxy=http://proxy.custom.com:80/
[Canonball:~]$ export https_proxy=http://proxy.custom.com:80/
</code></pre></div></div>

<p>Now your external connectivity should be good, proceed with YUM for package installation.</p>

<p>In the beginning we need to add the repo via config manager:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Canonball:~]$ yum-config-manager --add-repo https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/
adding repo from: https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/

[devhub.cisco.com_artifactory_xr600_3rdparty_x86_64_]
name=added from: https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/
baseurl=https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/
enabled=1
</code></pre></div></div>

<p>Enable new repo:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Canonball:~]$ yum-config-manager --enable    https://devhub.cisco.com/artifactory/xr600/3rdparty/x86_64/
[Canonball:~]$ yum check-update
Loaded plugins: downloadonly, protect-packages, rpm-persistence
localdb                                                                                                      |  951 B     00:00 ...
devhub.cisco.com_artifactory_xr600_3rdparty_x86_64_                                                          | 1.3 kB     00:00
devhub.cisco.com_artifactory_xr600_3rdparty_x86_64_/primary                                                  | 1.1 MB     00:01
devhub.cisco.com_artifactory_xr600_3rdparty_x86_64_                                                                       5912/5912
</code></pre></div></div>

<p>Proceed with installation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Canonball:~]$
[Canonball:~]$ yum install rsyslog

Loaded plugins: downloadonly, protect-packages, rpm-persistence
Setting up Remove Process
Resolving Dependencies
--&gt; Running transaction check

***Omitted output***

Installed:
  rsyslog.core2_64 0:7.4.4-r0.0

Complete!

</code></pre></div></div>

<p class="notice--warning">If you are facing issues with specific build versions or installation doesn’t go smoothly for you, <strong>rpm</strong> could be utilized directly, like in snippet below (rpm is already located on device hard drive).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Macrocarpa:~]$ rpm -ivh rsyslog-7.4.4-r0.0.core2_64.rpm
Preparing...                ########################################### [100%]
Stopping system log daemon...0
update-rc.d: /etc/init.d/syslog exists during rc.d purge (continuing)
 Removing any system startup links for syslog ...
  /etc/rc0.d/K20syslog
  /etc/rc1.d/K20syslog
  /etc/rc2.d/S20syslog
  /etc/rc3.d/S20syslog
  /etc/rc4.d/S20syslog
  /etc/rc5.d/S20syslog
  /etc/rc6.d/K20syslog
   1:rsyslog                ########################################### [100%]
update-alternatives: Linking //sbin/syslogd to /usr/sbin/rsyslogd
update-alternatives: Linking //etc/syslog.conf to /etc/rsyslog.conf
update-alternatives: Linking //etc/logrotate.d/syslog to /etc/logrotate.rsyslog
update-alternatives: Linking //etc/init.d/syslog to /etc/init.d/syslog.rsyslog
 Adding system startup for /etc/init.d/syslog.
starting rsyslogd ... done
</code></pre></div></div>

<p>To send messages to the remote server, we will need to configure rsyslog, in particular, modify its configuration file <em>/etc/rsyslog.conf</em></p>

<p>For TCP we will use @@</p>

<p>For UDP we will use @</p>

<p>String below will allow us to send all messages via TCP:</p>

<pre><code class="language-code">*.* @@&lt;remote_ip&gt;:514
</code></pre>

<p>If there is an intention to offload messages to Elasticsearch, we will need to convert them to JSON format. There are two ways how to do that:</p>

<ol>
  <li>Format incoming messages received on the server side;</li>
  <li>Send messages directly in JSON format.</li>
</ol>

<p>We will elaborate on example with the second option. To convert a message to JSON format we will add the template to rsyslog configuration file.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>template(name="JsonFormat"
  type="list") {
    constant(value="{")
      constant(value="\"@timestamp\":\"")     property(name="timereported" dateFormat="rfc3339")
      constant(value="\",\"@version\":\"1")
      constant(value="\",\"message\":\"")     property(name="msg" format="json")
      constant(value="\",\"sysloghost\":\"")  property(name="hostname")
      constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
      constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
      constant(value="\",\"programname\":\"") property(name="programname")
      constant(value="\",\"procid\":\"")      property(name="procid")
    constant(value="\"}\n")
}
</code></pre></div></div>

<p>The template is defined, next step to apply it:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*.* @&lt;remote_ip&gt;:10514;JsonFormat
</code></pre></div></div>

<p>With such configuration, the router will send messages to 2 destinations, one in the plain text format to port 514 and another in JSON format to port 10514.</p>

<p class="notice--info">Out of box Logstash supports UDP, TCP available via “<a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-tcp.html">TCP input plugin</a>”. Not to ample our guide, we will stick to UDP for now.</p>

<p>Validate the rsyslog config. No errors? All set!</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsyslogd -N1
</code></pre></div></div>

<p>Some extra commands, which will help you to do the health check on your setup. To check rsyslog version running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsyslogd -version
</code></pre></div></div>

<p>Check the Linux system log for rsyslog errors. You should see an event that it  it has started with no errors. Some logs may also be in /var/log/syslog.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cat /var/log/messages | grep rsyslog
</code></pre></div></div>

<p>Restart rsyslog to enable the changes applied to the configuration:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Macrocarpa:~]$ service syslog restart
stopping rsyslogd ... done
starting rsyslogd ... done
</code></pre></div></div>

<p class="notice--info">If you decide to utilize rsyslog version 8+, make sure you have library libestr version 1.9+</p>

<h2 id="filters">Filters</h2>

<p>rsyslog provides the comprehensive set of filters and rules. By specifying dot <em>(“.”)</em> in the config file, we determine that all information from all facilities would be sent to the remote location.<br />
What if we want to exclude some facilities from sending process?  Adding <strong>;</strong> should solve this case.</p>

<pre><code class="language-code">*.*;mail  
# will match all facilities, except mail

auth.warn 
# will match facility auth, with security level 'warning' or higher
</code></pre>

<p>What could be a filter example? Let’s say we want to search <strong>msg</strong> property of the incoming Syslog message, for a specific string and pipe it to the custom file. All messages with substring   <em>pam_unix(crond:session):</em>  now logged to <em>ncs-custom.log</em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>:msg, contains, "pam_unix(crond:session)" -/var/log/syslog-ng/ncs-custom.log
</code></pre></div></div>

<p class="notice--warning">Keep in mind, that filters are case-sensitive. ‘Pam’ or ‘PAM’ will not be filtered.</p>

<p>Official documentation with notification levels and more on filters <a href="https://www.rsyslog.com/doc/v8-stable/configuration/filters.html">here</a>.</p>

<h1 id="configuring-server-side">Configuring server side</h1>

<p>On a server side (aka receiver) we will run syslog-ng to get messages from routers in plain text. Syslog-ng would be run natively (the docker image also <a href="https://syslog-ng.com/blog/central-log-server-docker/">available</a>) and Elastic (Logstash + Elasticsearch) would start in docker container for easier deployment.</p>

<h2 id="syslog-ng">syslog-ng</h2>

<p>If you have Ubuntu, apt-get should be used to install syslog-ng.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install syslog-ng -y
</code></pre></div></div>

<p>Check that installation was successful. With apt, you will not get the latest version of software, but it will serve our purpose without limitations.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% syslog-ng --version
syslog-ng 3.5.6
Installer-Version: 3.5.6
Revision: 3.5.6-2.1 [@416d315] (Ubuntu/16.04)
Compile-Date: Oct 24 2015 03:49:19
</code></pre></div></div>

<p>Next step would be to modify Syslog configuration file <em>/etc/syslog-ng/syslog-ng.conf</em>. 
Following config lines will open port for listening and write all messages to file ncs.log</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source s_net {
    tcp(ip(0.0.0.0), port(514));
    udp(ip(0.0.0.0), port(514));
};

destination logfiles {
   file("/var/log/syslog-ng/ncs.log");
};

log {
    source(s_net);
    destination(logfiles);
};

</code></pre></div></div>

<p>The syslog-ng service should listen on all IP addresses, because we specify 0.0.0.0 and TCP/UDP port 514. If you want to listen to specific IP, just replace 0.0.0.0 with your required ip address.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ netstat -tulpn | grep 514
tcp        0      0 0.0.0.0:514             0.0.0.0:*               LISTEN      -
udp        0      0 0.0.0.0:514             0.0.0.0:*                           -
</code></pre></div></div>

<h2 id="elastic-stack">Elastic stack</h2>

<p>Open source software, such as Elasticsearch and Logstash provide you the tools to transform and store our log data.</p>

<p>We can verify the messages in JSON format are received on the server side, before proceeding with the installation. <a href="http://netcat.sourceforge.net/">netcat</a> is used for that.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc -ul server_ip 10514

{"@timestamp":"2018-06-03T19:10:01.524244+00:00","@version":"1","message":" pam_unix(crond:session): session opened for user root by (uid=0)","sysloghost":"Red_Pine","severity":"info","facility":"authpriv","programname":"crond","procid":"21501"}
{"@timestamp":"2018-06-03T19:10:01.524813+00:00","@version":"1","message":" (root) CMD (/usr/bin/logrotate /etc/logrotate.conf &gt;/dev/null 2&gt;&amp;1)","sysloghost":"Red_Pine","severity":"info","facility":"cron","programname":"CROND","procid":"21502"}
</code></pre></div></div>

<p>To proceed with the installation, pull the images:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull docker.elastic.co/logstash/logstash:6.2.4
docker pull docker.elastic.co/elasticsearch/elasticsearch:6.2.4
</code></pre></div></div>

<p>To let Logstash be aware of incoming rsyslog messages, we should provide configuration file logstash.conf:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Logstash will wait for input on port 10514;
# server_ip -&gt; ip of our machine;
# codec, specifies "json" receiving format
# "rsyslog" type used for identification messaging streams in the pipeline.
input {
  udp {
    host =&gt; "server_ip"
    port =&gt; 10514
    codec =&gt; "json"
    type =&gt; "rsyslog"
  }
}
# Filter block is empty, could be used in future
filter { }
output {
  if [type] == "rsyslog" {
    elasticsearch {
      hosts =&gt; [ "server_ip:9200" ]
    }
  }
}
</code></pre></div></div>

<p>Run the containers! For the Logstash container you can mount the whole folder with the config files, or specify the files directly.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -itd --rm --name=logstash -v ~/Documents/elastic/:/usr/share/logstash/pipeline/ docker.elastic.co/logstash/logstash:6.2.4 

docker run -itd -p 9200:9200 -p 9300:9300 --name=elasticsearch  -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:6.2.4

</code></pre></div></div>

<p>To verify, that Logstash is sending data to Elasticsearch, open a browser  <em>http://server_ip:9200/_all/_search?q=*&amp;pretty</em>.</p>

<p>You should see the output from rsyslog:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
      "_index" : ".monitoring-logstash",
      "_type" : "rsyslog",
      "_id" : "d9tyx2MBc17MjdSrF223",
      "_score" : 1.0,
      "_source":{"@timestamp":"2018-06-03T21:00:44.739673+00:00","@version":"1","message":" + /dev/pts/8 root:root","sysloghost":"Red_Pine","severity":"info","facility":"authpriv","programname":"su","procid":"24267"}
    },
</code></pre></div></div>

<p>Congratulations, all your software is up and running!</p>

<h2 id="logrotate">logrotate</h2>

<p>It’s worth to mention one critical component for logging solution. The space on your hard drive is finite. It’s worth investing some amount of time to configure proper rules for your machine to free up space. <a href="https://syslog-ng.com/documents/html/syslog-ng-ose-latest-guides/en/syslog-ng-ose-guide-admin/html/example-logrotate.html">Logrorate</a> is a perfect solution for that. 
Let’s take a look at configuration excerpts for ncs.log:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cisco@walnut ~ % cat /etc/logrotate.d/apt
/var/log/syslog-ng/ncs.log {
  rotate 24
  monthly
  compress
  missingok
  notifempty
}
</code></pre></div></div>
<ul>
  <li><strong>rotate 24</strong> - 24 old log files saved;</li>
  <li><strong>monthly</strong> - rotation frequency;</li>
  <li><strong>compress</strong> - gzip used by default, to compress old log files;</li>
  <li><strong>missingok</strong> - no errors if log file is missing;</li>
  <li><strong>notifempty</strong> - skip rotate, if log file is empty.</li>
</ul>

<p>With such a simple addition, your hard drive capacity will last longer.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Your logs streamed via rsyslog to multiple destinations: syslog-ng and Logstash. Consider visualization with some tools like Kibana or another application and elevate your logging techniques.</p>

        
      </section>

      <footer class="page__meta">
        
        




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://0.0.0.0:4000/application-hosting/tags/#iosxr" class="page__taxonomy-item" rel="tag">iosxr</a><span class="sep">, </span>
    
      
      
      <a href="http://0.0.0.0:4000/application-hosting/tags/#logging" class="page__taxonomy-item" rel="tag">Logging</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-05-25T20:33:00+00:00">May 25, 2018</time></p>
        
        

      </footer>

      

<section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://0.0.0.0:4000/application-hosting/tutorials/2018-05-25-logging-on-ios-xr-guest-os-with-rsyslog-and-elastic-stack/" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

    <br>
    <br>
    <br>
</section>


    </div>

    
      

<div class="page__comments">
  <h4 class="page__comments-title">Leave a Comment</h4>
  
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/xrdocs"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/xrdocs"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="http://0.0.0.0:4000/application-hosting/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">This site is maintained by Cisco Systems, Inc. employees. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="http://0.0.0.0:4000/application-hosting/assets/js/main.min.js"></script>
<script src="http://0.0.0.0:4000/application-hosting/assets/js/scrollmenu.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78256516-1', 'auto');
  ga('send', 'pageview');
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'xrdocs';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






<!-- material-scrolltop button -->
<button class="material-scrolltop" type="button"></button>

<!-- material-scrolltop plugin -->
<script src="http://0.0.0.0:4000/application-hosting/assets/js/material-scrolltop.js"></script>

<!-- Initialize material-scrolltop with (minimal) -->
<script>
    $('body').materialScrollTop();
</script>


  </body>
</html>

