

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>            XR toolbox, Part 4: Bring your own Container (LXC) App      IOS XR Application Hosting @xrdocs      </title>







<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="IOS XR Application Hosting @xrdocs">
<meta property="og:title" content="XR toolbox, Part 4: Bring your own Container (LXC) App">


  <link rel="canonical" href="https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/">
  <meta property="og:url" content="https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/">



  <meta property="og:description" content="Launch a Container app (LXC) on IOS-XR">



  <meta name="twitter:site" content="@xrdocs">
  <meta name="twitter:title" content="XR toolbox, Part 4: Bring your own Container (LXC) App">
  <meta name="twitter:description" content="Launch a Container app (LXC) on IOS-XR">
  <meta name="twitter:url" content="https://xrdocs.io/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://xrdocs.io/application-hosting/images/app-hosting-xrdocs.jpg">
    
  

  
    <meta name="twitter:creator" content="@Akshat Sharma">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2016-06-16T08:17:00+00:00">
  
    <link rel="next" href="https://xrdocs.io/application-hosting/tutorials/2016-06-08-ios-xr-ansible-container-deployment/" title="IOS-XR: Ansible based LXC deployment">
  
  
    <link rel="prev" href="https://xrdocs.io/application-hosting/tutorials/2016-06-06-xr-toolbox-app-development-topology" title="XR Toolbox, Part 3 : App Development Topology ">
  



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://xrdocs.io/application-hosting",
      "logo": "https://xrdocs.io/application-hosting/images/app-hosting-xrdocs.jpg"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "person",
      "name" : "Cisco Systems Inc",
      "url" : "https://xrdocs.io/application-hosting",
      "sameAs" : ["https://twitter.com/xrdocs"]
    }
  </script>






<!-- end SEO -->

<link href="https://xrdocs.io/application-hosting/feed.xml" type="application/atom+xml" rel="alternate" title="IOS XR Application Hosting @xrdocs Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="jgRKKm6B9FwJJPXxpmc0-EP3D0Mh8JHXaJqoYIGj1ek" />

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<script>
if (!(window.location.host.startsWith("127.0.0.1") || window.location.host.startsWith("localhost")) && (window.location.host.substr(-3) == '.io') && (window.location.protocol != "https:"))
    window.location.protocol = "https";
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/application-hosting/assets/css/main.css">
<meta http-equiv="cleartype" content="on">
<style>
.underline-on-hover:hover {
    text-decoration: underline;
}
.searchForm{
      border-radius:5px;
      -moz-border-radius:5px;
      -webkit-border-radius:5px;
      width: 900px;
   }
#search_results{
      display: table; margin:0 auto;
   }
</style>
</style>

    

<!-- start custom head snippets -->

<link href="https://xrdocs.io/application-hosting/assets/css/lity.min.css" rel="stylesheet">
<link href="https://xrdocs.io/application-hosting/assets/css/cisco-sans.min.css" rel="stylesheet">
<link href="https://xrdocs.io/application-hosting/assets/css/material-scrolltop.css" rel="stylesheet">

<link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://xrdocs.io/application-hosting/images/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="https://xrdocs.io/application-hosting/images/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="https://xrdocs.io/application-hosting/images/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="https://xrdocs.io/application-hosting/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="https://xrdocs.io/application-hosting/images/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="https://xrdocs.io/application-hosting/images/favicon-128.png" sizes="128x128" />
<link rel="shortcut icon" href="https://xrdocs.io/application-hosting/images/favicon_cisco.ico" />
<meta name="application-name" content="&nbsp;"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="https://xrdocs.io/application-hosting/images/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="https://xrdocs.io/application-hosting/images/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="https://xrdocs.io/application-hosting/images/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="https://xrdocs.io/application-hosting/images/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="https://xrdocs.io/application-hosting/images/mstile-310x310.png" />


<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu" style="padding-left:2em;">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <img src="https://xrdocs.io/application-hosting/images/xrdocs_logo.png" width="45px" height="45px" alt="xrdocs logo" style="float:left;">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="https://xrdocs.io">@xrdocs</a></li>
          <li class="masthead__menu-item"><a href="https://xrdocs.io/application-hosting/">App-Hosting</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    



<div id="main" role="main">
  


  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="https://xrdocs.io/application-hosting/images/avatars/" class="author__avatar" alt="">
    
  </div>

  <div class="author__content">
    <h3 class="author__name"></h3>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>


  </div>
    <br><button class="btn"><a href="//pdfcrowd.com/url_to_pdf/" style="color:white">Save as PDF</a></button>

</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="XR toolbox, Part 4: Bring your own Container (LXC) App">
    <meta itemprop="description" content="Launch a Container app (LXC) on IOS-XR">
    <meta itemprop="datePublished" content="June 16, 2016">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">XR toolbox, Part 4: Bring your own Container (LXC) App
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 


  16 
</p>
          
        </header>
      

    
      
        





<div class="breadcrumbs">
  <ol itemscope itemtype="http://schema.org/BreadcrumbList" style="margin:0;padding:0;">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" style="margin:0;padding:0;">
          <a href="https://xrdocs.io/application-hosting/" itemprop="item"><span itemprop="name"></span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep"></span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem" style="margin:0;padding:0;">
          <a href="https://xrdocs.io/application-hosting/tutorials" itemprop="item"><span itemprop="name">Tutorials</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep"></span>
      
    
      
      
        <li class="current" style="margin:0;padding:0;">XR toolbox, Part 4: Bring your own Container (LXC) App</li>
      
    
  </ol>
</div>

      
    

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-table"></i> Launching a Container App</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#pre-requisites" id="markdown-toc-pre-requisites">Pre-requisites</a></li>
  <li><a href="#create-a-container-rootfs" id="markdown-toc-create-a-container-rootfs">Create a container rootfs</a>    <ul>
      <li><a href="#install-lxc-tools-on-devbox" id="markdown-toc-install-lxc-tools-on-devbox">Install lxc tools on devbox</a></li>
      <li><a href="#launch-an-lxc-container-on-the-devbox" id="markdown-toc-launch-an-lxc-container-on-the-devbox">Launch an LXC container on the devbox</a></li>
      <li><a href="#createinstall-your-app" id="markdown-toc-createinstall-your-app">Create/Install your app</a></li>
      <li><a href="#change-ssh-port-inside-your-container" id="markdown-toc-change-ssh-port-inside-your-container">Change SSH port inside your container</a></li>
      <li><a href="#shutdown-and-package-your-container" id="markdown-toc-shutdown-and-package-your-container">Shutdown and package your container</a></li>
    </ul>
  </li>
  <li><a href="#create-lxc-spec-xml-file" id="markdown-toc-create-lxc-spec-xml-file">Create LXC SPEC XML File</a></li>
  <li><a href="#transfer-rootfs-and-xml-file-to-xr" id="markdown-toc-transfer-rootfs-and-xml-file-to-xr">Transfer rootfs and XML file to XR</a></li>
  <li><a href="#untar-rootfs-under-miscapp_host" id="markdown-toc-untar-rootfs-under-miscapp_host">Untar rootfs under /misc/app_host/</a></li>
  <li><a href="#use-virsh-to-launch-container" id="markdown-toc-use-virsh-to-launch-container">Use virsh to launch container</a></li>
  <li><a href="#test-your-app" id="markdown-toc-test-your-app">Test your app!</a>    <ul>
      <li><a href="#set-the-src-hint-for-application-traffic" id="markdown-toc-set-the-src-hint-for-application-traffic">Set the src-hint for Application traffic</a></li>
      <li><a href="#see-if-things-work" id="markdown-toc-see-if-things-work">See if things work!</a></li>
    </ul>
  </li>
</ul>

  </nav>
</aside>

<p>Check out Part 3 of the XR toolbox series: <a href="https://xrdocs.io/application-hosting/tutorials/2016-06-06-xr-toolbox-app-development-topology">App Development Topology</a>.</p>

<h2 id="introduction">Introduction</h2>

<p>If you haven’t checked out the earlier parts to the XR toolbox Series, then you can do so here:</p>

<blockquote>

  <p><a href="https://xrdocs.io/application-hosting/tags/#xr-toolbox">XR Toolbox Series</a></p>
</blockquote>

<p>The purpose of this series is simple. Get users started with an IOS-XR setup on their laptop and incrementally enable them to try out the application-hosting infrastructure on IOS-XR.</p>

<p>In this part, we explore how a user can build and deploy their own container (LXC) based applications on IOS-XR.</p>

<h2 id="pre-requisites">Pre-requisites</h2>

<p>Before we begin, let’s make sure you’ve set up your development environment.
If you haven’t checked it out, go through the “App-Development Topology” tutorial here:</p>

<blockquote>

  <p><a href="https://xrdocs.io/application-hosting/tutorials/2016-06-06-xr-toolbox-app-development-topology">XR Toolbox, Part 3: App Development Topology</a></p>
</blockquote>

<p>Follow the instructions to get your topology up and running as shown below:</p>

<p><img src="https://xrdocs.github.io/xrdocs-images/assets/tutorial-images/app_dev_topology.png" alt="app dev topo" /></p>

<p>If you’ve reached the end of the above tutorial, you should be able to issue a <code class="highlighter-rouge">vagrant status</code> in the <code class="highlighter-rouge">vagrant-xrdocs/lxc-app-topo-bootstrap</code> directory to see a rtr (IOS-XR) and a devbox (Ubuntu/trusty) instance running.</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$ pwd
<mark>/Users/akshshar/vagrant-xrdocs/lxc-app-topo-bootstrap </mark>
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$ 
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$<mark> vagrant status </mark>
Current machine states:

rtr                       running (virtualbox)
devbox                    running (virtualbox)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$ 

</code>
</pre>
</div>

<p class="notice--success">All good? Perfect. Let’s start building our container application tar ball.</p>

<blockquote class="notice">

  <p><img src="https://raw.githubusercontent.com/xrdocs/xrdocs-images/gh-pages/assets/tutorial-images/mkorshun/hosted_apps/01_workflow_app_hosting.png" width="400" height="400" class="align-right" /></p>

  <p><strong>The figure on the right illustrates the basic steps to undertake to launch an lxc container on IOS-XR 6.0+</strong>:</p>

  <ul>
    <li>We will build the container rootfs tar ball on our devbox (see topology above)</li>
    <li>The rootfs tar ball will then be transferred to IOS-XR</li>
    <li>The rootfs will  be launched on the underlying hypervisor using the virsh command in XR shell.</li>
  </ul>
</blockquote>

<h2 id="create-a-container-rootfs">Create a container rootfs</h2>

<div class="notice--warning">
  
<h4 id="using-a-custom-rootfs-tar-ball">Using a custom rootfs tar ball</h4>

<p>The technique presented here focuses on the creation of a container from scratch (using a base ubuntu template) followed by the installation of an application for first-time users.
A user can easily use their own pre-built rootfs tar ball and ignore this section altogether.</p>

<p>The only point to remember is that if you expect to use SSH access into the container after deployment to XR, then change the default SSH port in /etc/ssh/sshd_config in your rootfs to something other than 22/57722 (or any other port you expect XR to use based on your config).</p>

<p>This is showcased in the following section below:</p>

<p><a href="https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/#change-ssh-port-inside-your-container">Change SSH port inside your container</a></p>


</div>

<p>To launch an LXC container we need two things:</p>

<ul>
  <li>A container rootfs tar ball</li>
  <li>An XML file to launch the container using <code class="highlighter-rouge">virsh/libvirt</code></li>
</ul>

<p>To create them, we’ll hop onto our devbox (Ubuntu/trusty) VM in the topology and install lxc-tools. lxc-tools will be used to create a container rootfs tar ball.</p>

<h3 id="install-lxc-tools-on-devbox">Install lxc tools on devbox</h3>

<p>SSH into the devbox:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$<mark> vagrant ssh devbox</mark>
Welcome to Ubuntu 14.04.4 LTS (GNU/Linux 3.13.0-87-generic x86_64)

 * Documentation:  https://help.ubuntu.com/

  System information as of Thu Jun 16 14:27:47 UTC 2016

  System load:  0.0               Processes:           74
  Usage of /:   3.5% of 39.34GB   Users logged in:     0
  Memory usage: 25%               IP address for eth0: 10.0.2.15
  Swap usage:   0%                IP address for eth1: 11.1.1.20

  Graph this data and manage this system at:
    https://landscape.canonical.com/

  Get cloud support with Ubuntu Advantage Cloud Guest:
    http://www.ubuntu.com/business/services/cloud

0 packages can be updated.
0 updates are security updates.


Last login: Thu Jun 16 14:27:47 2016 from 10.0.2.2
vagrant@vagrant-ubuntu-trusty-64:~$ 
</code>
</pre>
</div>

<p>Install lxc tools inside the devbox</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nt">-y</span> install lxc
</code></pre></div></div>

<p>Check that lxc was properly installed:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">sudo </span>lxc-start <span class="nt">--version</span>
1.0.8
vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>
</code></pre></div></div>

<h3 id="launch-an-lxc-container-on-the-devbox">Launch an LXC container on the devbox</h3>

<p>Using the standard ubuntu template available with lxc, let’s create and start the ubuntu container inside devbox:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
vagrant@vagrant-ubuntu-trusty-64:~$<mark> sudo lxc-create -t ubuntu --name xr-lxc-app</mark>
Checking cache download in /var/cache/lxc/trusty/rootfs-amd64 ... 
Installing packages in template: ssh,vim,language-pack-en
Downloading ubuntu trusty minimal ...
I: Retrieving Release 
I: Retrieving Release.gpg 
I: Checking Release signature
I: Valid Release signature (key id 790BC7277767219C42C86F933B4FE6ACC0B21F32)
I: Retrieving Packages 

------------------------------ snip output ------------------------------------
</code>
</pre>
</div>

<p class="notice--info">This process will take some time as the ubuntu rootfs template is downloaded for you by the lxc tools.</p>

<p>Once the container template is installed successfully, it should show up in the lxc-ls output:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
vagrant@vagrant-ubuntu-trusty-64:~$<mark> sudo lxc-ls --fancy </mark>
NAME        STATE    IPV4  IPV6  AUTOSTART  
------------------------------------------
xr-lxc-app  STOPPED  -     -     NO         
vagrant@vagrant-ubuntu-trusty-64:~$ 
</code>
</pre>
</div>

<p>Now let’s start the container:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
vagrant@vagrant-ubuntu-trusty-64:~$<mark> sudo lxc-start --name xr-lxc-app </mark>
&lt;4&gt;init: plymouth-upstart-bridge main process (5) terminated with status 1
&lt;4&gt;init: plymouth-upstart-bridge main process ended, respawning
&lt;4&gt;&gt;init: hwclock main process (7) terminated with status 77
&lt;4&gt;&gt;init: plymouth-upstart-bridge main process (15) terminated with status 1
&lt;4&gt;&gt;init: plymouth-upstart-bridge main process ended, respawning

------------------------------ snip output ------------------------------------

</code>
</pre>
</div>

<p>You will be taken to the login prompt.</p>

<p class="notice--info">The Default credentials are:<br />
Username:  <strong>ubuntu</strong><br />
Password:  <strong>ubuntu</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Ubuntu 14.04.4 LTS xr-lxc-app console

xr-lxc-app login: &lt;4&gt;init: setvtrgb main process <span class="o">(</span>428<span class="o">)</span> terminated with status 1
&lt;4&gt;init: plymouth-upstart-bridge main process <span class="o">(</span>23<span class="o">)</span> killed by TERM signal


Ubuntu 14.04.4 LTS xr-lxc-app console

xr-lxc-app login: ubuntu
Password: 
Welcome to Ubuntu 14.04.4 LTS <span class="o">(</span>GNU/Linux 3.13.0-87-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com/

The programs included with the Ubuntu system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

ubuntu@xr-lxc-app:~<span class="nv">$ </span>


</code></pre></div></div>

<p class="notice--success">Perfect! You’ve launched an ubuntu container on your devbox.</p>

<h3 id="createinstall-your-app">Create/Install your app</h3>

<p>In this example we’ll install iperf as a sample application.You may choose to skip this step if you have another app in mind.</p>

<p class="notice--info">sudo password:  <strong>ubuntu</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
ubuntu@xr-lxc-app:~<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> install iperf
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>ubuntu: 
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following NEW packages will be installed:
  iperf
0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
Need to get 56.3 kB of archives.
After this operation, 174 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu/ trusty/universe iperf amd64 2.0.5-3 <span class="o">[</span>56.3 kB]
Fetched 56.3 kB <span class="k">in </span>2s <span class="o">(</span>23.5 kB/s<span class="o">)</span>
Selecting previously unselected package iperf.
<span class="o">(</span>Reading database ... 14629 files and directories currently installed.<span class="o">)</span>
Preparing to unpack .../iperf_2.0.5-3_amd64.deb ...
Unpacking iperf <span class="o">(</span>2.0.5-3<span class="o">)</span> ...
Setting up iperf <span class="o">(</span>2.0.5-3<span class="o">)</span> ...
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
ubuntu@xr-lxc-app:~<span class="nv">$ </span>iperf <span class="nt">-v</span>
iperf version 2.0.5 <span class="o">(</span>08 Jul 2010<span class="o">)</span> pthreads
ubuntu@xr-lxc-app:~<span class="nv">$ </span>

</code></pre></div></div>

<h3 id="change-ssh-port-inside-your-container">Change SSH port inside your container</h3>

<p>When we deploy the container to IOS-XR, we will share XR’s network namespace. Since IOS-XR already uses up port 22 and port 57722 for its own purposes, we need to pick some other port for our container.</p>

<p class="notice--info"><strong>Our recommendation? - Pick some port in the 58xxx range.</strong></p>

<p>Let’s change the SSH port to 58822:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
ubuntu@xr-lxc-app:~$<mark> sudo sed -i s/Port\ 22/Port\ 58822/ /etc/ssh/sshd_config </mark>
ubuntu@xr-lxc-app:~$ 
</code>
</pre>
</div>

<p>Check that your port was updated successfully:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@xr-lxc-app:~<span class="nv">$ </span><span class="nb">cat</span> /etc/ssh/sshd_config | <span class="nb">grep </span>Port
Port 58822
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
</code></pre></div></div>

<p class="notice--success">We’re good!</p>

<h3 id="shutdown-and-package-your-container">Shutdown and package your container</h3>

<p>Issue a shutdown to escape</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@xr-lxc-app:~<span class="nv">$ </span><span class="nb">sudo </span>shutdown <span class="nt">-h</span> now
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
Broadcast message from ubuntu@xr-lxc-app
	<span class="o">(</span>/dev/lxc/console<span class="o">)</span> at 19:37 ...

The system is going down <span class="k">for </span>halt NOW!

<span class="nt">------------------------------</span> snip output <span class="nt">------------------------------------</span>

mount: cannot mount block device /dev/sda1 read-only
 <span class="k">*</span> Will now halt
vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>
vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>
</code></pre></div></div>

<p>We’re back on our devbox.
Now hop over to the directory <code class="highlighter-rouge">/var/lib/lxc/xr-lxc-app</code> and package the rootfs into a tar ball.
In the end we transfer the tar ball to the home directory (~/ or /home/vagrant)</p>

<p class="notice--warning"><strong>You will need to be root for this operation</strong></p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
vagrant@vagrant-ubuntu-trusty-64:~$<mark> sudo -s </mark>
root@vagrant-ubuntu-trusty-64:~# 
root@vagrant-ubuntu-trusty-64:~#<mark> whoami </mark>
root
root@vagrant-ubuntu-trusty-64:~#<mark> cd /var/lib/lxc/xr-lxc-app/ </mark>
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app# ls
config  fstab  rootfs
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app# <mark>cd rootfs </mark>
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app/rootfs# 
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app/rootfs#<mark> tar -czf xr-lxc-app-rootfs.tar.gz * </mark>
tar: dev/log: socket ignored
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app/rootfs#
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app/rootfs#<mark>mv *.tar.gz /home/vagrant</mark>
root@vagrant-ubuntu-trusty-64:/var/lib/lxc/xr-lxc-app/rootfs#<mark>ls -l /home/vagrant</mark>
total 119984
-rw-r--r-- 1 root root 122863332 Jun 16 19:41 xr-lxc-app-rootfs.tar.gz
</code>
</pre>
</div>

<h2 id="create-lxc-spec-xml-file">Create LXC SPEC XML File</h2>

<p>We need to create an XML file that will define different parameters (cpu, mem, rootfs location etc.) for the container launch on IOS-XR (which uses libvirt).
On the devbox, use your favorite editor (vi, nano, pico etc.) to create a new file called <br />
<code class="highlighter-rouge">xr-lxc-app.xml</code> under <code class="highlighter-rouge">/home/vagrant</code> of the devbox with the following content:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">'lxc'</span> <span class="na">xmlns:lxc=</span><span class="s">'http://libvirt.org/schemas/domain/lxc/1.0'</span> <span class="nt">&gt;</span>
<span class="nt">&lt;name&gt;</span>xr-lxc-app<span class="nt">&lt;/name&gt;</span>
<span class="nt">&lt;memory&gt;</span>327680<span class="nt">&lt;/memory&gt;</span>
<span class="nt">&lt;os&gt;</span>
<span class="nt">&lt;type&gt;</span>exe<span class="nt">&lt;/type&gt;</span>
<span class="nt">&lt;init&gt;</span>/sbin/init<span class="nt">&lt;/init&gt;</span>
<span class="nt">&lt;/os&gt;</span>
<span class="nt">&lt;lxc:namespace&gt;</span>
<span class="nt">&lt;sharenet</span> <span class="na">type=</span><span class="s">'netns'</span> <span class="na">value=</span><span class="s">'global-vrf'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/lxc:namespace&gt;</span>
<span class="nt">&lt;vcpu&gt;</span>1<span class="nt">&lt;/vcpu&gt;</span>
<span class="nt">&lt;clock</span> <span class="na">offset=</span><span class="s">'utc'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;on</span><span class="na">_poweroff</span><span class="nt">&gt;</span>destroy<span class="nt">&lt;/on</span><span class="err">_poweroff</span><span class="nt">&gt;</span>
<span class="nt">&lt;on</span><span class="na">_reboot</span><span class="nt">&gt;</span>restart<span class="nt">&lt;/on</span><span class="err">_reboot</span><span class="nt">&gt;</span>
<span class="nt">&lt;on</span><span class="na">_crash</span><span class="nt">&gt;</span>destroy<span class="nt">&lt;/on</span><span class="err">_crash</span><span class="nt">&gt;</span>
<span class="nt">&lt;devices&gt;</span>
<span class="nt">&lt;emulator&gt;</span>/usr/lib64/libvirt/libvirt_lxc<span class="nt">&lt;/emulator&gt;</span>
<span class="nt">&lt;filesystem</span> <span class="na">type=</span><span class="s">'mount'</span><span class="nt">&gt;</span>
<span class="nt">&lt;source</span> <span class="na">dir=</span><span class="s">'/misc/app_host/xr-lxc-app/'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;target</span> <span class="na">dir=</span><span class="s">'/'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/filesystem&gt;</span>
<span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">'pty'</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/devices&gt;</span>
<span class="nt">&lt;/domain&gt;</span>

</code></pre></div></div>

<blockquote class="notice--info">

  <p>A couple of configuration knobs seem interesting in the above XML file:</p>

  <ul>
    <li>
      <p>The netns (network namespace) setting:</p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>`<span class="nt">&lt;sharenet</span> <span class="na">type=</span><span class="s">'netns'</span> <span class="na">value=</span><span class="s">'global-vrf'</span><span class="nt">/&gt;</span>`;
</code></pre></div>      </div>

      <p>In IOS-XR the <strong>‘global-vrf’ network namespace houses all the XR Gig/Mgmt interfaces that are 
in the global/default VRF.</strong> The sharenet setting above makes sure that the container on launch 
will also have access to all of XR’s interfaces natively</p>
    </li>
    <li>
      <p>The rootfs mount volume:</p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>`<span class="nt">&lt;source</span> <span class="na">dir=</span><span class="s">'/misc/app_host/xr-lxc-app/'</span><span class="nt">/&gt;</span>`;
</code></pre></div>      </div>

      <p><strong>/misc/app_host/ in IOS-XR is a special mount volume</strong> that is designed to provide nearly 3.9G 
of Disk space on IOS-XRv and varying amounts on other platforms (NCS5508, ASR9k) etc. This 
mount volume may be used to host custom container rootfs and other large files without using up 
XR’s disk space. <strong>In this case we expect the rootfs to be untarred in the 
/misc/app_host/xr-lxc-app/ directory</strong></p>
    </li>
  </ul>
</blockquote>

<p>Your LXC app is now ready to be deployed! You should have the following two components in the home directory of the devbox:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@vagrant-ubuntu-trusty-64:~# <span class="nb">pwd</span>
/home/vagrant
root@vagrant-ubuntu-trusty-64:~# <span class="nb">ls</span> <span class="nt">-l</span>
total 119988
<span class="nt">-rw-r--r--</span> 1 root root 122863332 Jun 16 19:41 xr-lxc-app-rootfs.tar.gz
<span class="nt">-rw-r--r--</span> 1 root root       590 Jun 16 23:29 xr-lxc-app.xml
root@vagrant-ubuntu-trusty-64:~# 
</code></pre></div></div>

<h2 id="transfer-rootfs-and-xml-file-to-xr">Transfer rootfs and XML file to XR</h2>

<p>We can either use the XR Gig or Mgmt interface to transfer the files.
IOS-XR runs openssh in the linux environment on port 57722.</p>

<blockquote class="notice--info">

  <p>We need to transfer the files to the <strong>/misc/app_host</strong> volume on IOS-XR.
However, /misc/app_host is owned by root and root access over SSH is not allowed, for obvious security reasons.</p>

  <p>Hence, to enable the transfer of custom files to IOS-XR, we provide a <code class="highlighter-rouge">/misc/app_host/scratch</code> directory which is owned by the app_host group. Any user transferring files over SSH to this directory must be part of the app_host group to have access.The user <code class="highlighter-rouge">vagrant</code> is already part of the app_host group.</p>
</blockquote>

<p><strong>Transfer using the Gig interface:</strong></p>

<p class="notice--info"><strong>The password for the vagrant user is <code class="highlighter-rouge">vagrant</code></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp -P 57722 /home/vagrant/xr-lxc-app-rootfs.tar.gz vagrant@11.1.1.10:/misc/app_host/scratch/
scp -P 57722 /home/vagrant/xr-lxc-app.xml vagrant@11.1.1.10:/misc/app_host/scratch/
</code></pre></div></div>
<p>Where 11.1.1.10 is the directly connected Gig0/0/0/0 interface of IOS-XR instance (this config was explained in the <a href="https://xrdocs.io/application-hosting/tutorials/2016-06-06-xr-toolbox-app-development-topology">XR Toolbox, Part 3: App Development Topology</a> tutorial).</p>

<p><strong>But this process might be slow since Gig interfaces in the Vagrant IOS-XR image are rate-limited.</strong></p>

<p><strong>Transfer using the Mgmt interface</strong></p>

<p>Vagrant forwards the port 57722 to some host port for IOS-XR over the management port. In Virtualbox, the IP address of the host (your laptop) is always 10.0.2.2 for the NAT’ed port.</p>

<p>So determine the forwarded port for port 57722 for XR on your laptop shell (in a separate window):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar<span class="nv">$ </span>vagrant port rtr
The forwarded ports <span class="k">for </span>the machine are listed below. Please note that
these values may differ from values configured <span class="k">in </span>the Vagrantfile <span class="k">if </span>the
provider supports automatic port collision detection and resolution.

    22 <span class="o">(</span>guest<span class="o">)</span> <span class="o">=&gt;</span> 2223 <span class="o">(</span>host<span class="o">)</span>
 57722 <span class="o">(</span>guest<span class="o">)</span> <span class="o">=&gt;</span> 2222 <span class="o">(</span>host<span class="o">)</span>
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar<span class="nv">$ </span>

</code></pre></div></div>

<p>Now use port <code class="highlighter-rouge">2222</code> to transfer the files over the management port using the host IP = 10.0.2.2 from your devbox</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>scp <span class="nt">-P</span> 2222 /home/vagrant/<span class="k">*</span>.<span class="k">*</span> vagrant@10.0.2.2:/misc/app_host/scratch
The authenticity of host <span class="s1">'[10.0.2.2]:2222 ([10.0.2.2]:2222)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is db:25:e2:27:49:2a:7b:27:e1:76:a6:7a:e4:70:f5:f7.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span><span class="o">[</span>10.0.2.2]:2222<span class="s1">' (ECDSA) to the list of known hosts.
vagrant@10.0.2.2'</span>s password: 
xr-lxc-app-rootfs.tar.gz                                   100%  117MB  16.7MB/s   00:07    
xr-lxc-app.xml                                             100%  590     0.6KB/s   00:00    
vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span>

</code></pre></div></div>

<h2 id="untar-rootfs-under-miscapp_host">Untar rootfs under /misc/app_host/</h2>

<p>Let’s hop onto the IOS-XR instance.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar<span class="nv">$ </span>vagrant ssh rtr
Last login: Thu Jun 16 19:45:33 2016 from 10.0.2.2
xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>
xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>
</code></pre></div></div>

<p>Create a directory <code class="highlighter-rouge">xr-lxc-app/</code>(remember the source dir in the XML file?) under <code class="highlighter-rouge">/misc/app_host</code>:</p>

<p class="notice--info">You need to be sudo to perform the next set of tasks.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mkdir /misc/app_host/xr-lxc-app/
</code></pre></div></div>

<p>Now untar the rootfs tar-ball that we transferred to the /misc/app_host/scratch directory into the newly created /misc/app_host/xr-lxc-app/ directory.</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
xr-vm_node0_RP0_CPU0:~$<mark>cd /misc/app_host/xr-lxc-app/ </mark>
xr-vm_node0_RP0_CPU0:/misc/app_host/xr-lxc-app$ 
xr-vm_node0_RP0_CPU0:/misc/app_host/xr-lxc-app$<mark>sudo tar -zxf ../scratch/xr-lxc-app-rootfs.tar.gz</mark>
tar: dev/mpu401data: Cannot mknod: Operation not permitted
tar: dev/rmidi3: Cannot mknod: Operation not permitted
tar: dev/rmidi2: Cannot mknod: Operation not permitted
tar: dev/smpte1: Cannot mknod: Operation not permitted
tar: dev/audio1: Cannot mknod: Operation not permitted
tar: dev/smpte0: Cannot mknod: Operation not permitted
tar: dev/midi0: Cannot mknod: Operation not permitted
tar: dev/mixer1: Cannot mknod: Operation not permitted
tar: dev/smpte3: Cannot mknod: Operation not permitted

--------------------------- snip output --------------------------
</code>
</pre>
</div>

<p class="notice--warning">Ignore the “Operation not permitted” messages when you untar. These are harmless.</p>

<h2 id="use-virsh-to-launch-container">Use virsh to launch container</h2>

<p>Now we use the XML file that we transferred to <code class="highlighter-rouge">/misc/app_host/scratch</code> to launch our container.</p>

<p class="notice--info">libvirtd is the daemon running on IOS-XR to help launch LXC containers. The client for libvirtd (virsh) is made available in the XR linux shell to interact with the libvirtd daemon.</p>

<p>To perform the virsh client commands, you will need to be root. In order to properly source the right environment variables for the virsh commands to connect to the libvirtd daemon, use the “-i” flag with “sudo” when becoming root.</p>

<p>Become root:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-i</span>
xr-vm_node0_RP0_CPU0:~<span class="err">$</span>

</code></pre></div></div>

<p class="notice--info">The “vagrant” user is already a part of the sudoers group, so you won’t be asked for the sudo password. But when you create your own users, expect the password prompt to show up.</p>

<p>To list the current running containers:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>virsh list
 Id    Name                           State
<span class="nt">----------------------------------------------------</span>
 4922  sysadmin                       running
 12010 default-sdr--1                 running

xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>

</code></pre></div></div>

<p>Now launch the container using <code class="highlighter-rouge">virsh create</code> and the XML file we transferred earlier:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>

xr-vm_node0_RP0_CPU0:~$<mark> virsh create /misc/app_host/scratch/xr-lxc-app.xml </mark>
Domain xr-lxc-app created from /misc/app_host/scratch/xr-lxc-app.xml

xr-vm_node0_RP0_CPU0:~$ 
xr-vm_node0_RP0_CPU0:~$ 
xr-vm_node0_RP0_CPU0:~$ virsh list 
 Id    Name                           State
----------------------------------------------------
 4922  sysadmin                       running
 <mark>7315  xr-lxc-app                     running</mark>
 12010 default-sdr--1                 running

xr-vm_node0_RP0_CPU0:~$ 
</code>
</pre>
</div>

<p>To get into the container, you have two options:</p>

<p>Our credentials for the container were:</p>

<p class="notice--info">Username: <strong>ubuntu</strong>
Password: <strong>ubuntu</strong></p>

<ul>
  <li>
    <p>Use <code class="highlighter-rouge">virsh console</code>:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  
xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>virsh console xr-lxc-app
Connected to domain xr-lxc-app
Escape character is ^]
init: Unable to create device: /dev/kmsg
<span class="k">*</span> Stopping Send an event to indicate plymouth is up                     <span class="o">[</span> OK <span class="o">]</span>
<span class="k">*</span> Starting Mount filesystems on boot                                    <span class="o">[</span> OK <span class="o">]</span>
<span class="k">*</span> Starting Signal sysvinit that the rootfs is mounted                   <span class="o">[</span> OK <span class="o">]</span>
<span class="k">*</span> Starting Fix-up sensitive /proc filesystem entries                    <span class="o">[</span> OK <span class="o">]</span>

<span class="nt">--------------------------------</span> snip output <span class="nt">---------------------------------</span>
  
Ubuntu 14.04.4 LTS xr-lxc-app tty1

xr-lxc-app login: ubuntu
Password: 
Last login: Thu Jun 16 19:23:10 UTC 2016 on lxc/console
Welcome to Ubuntu 14.04.4 LTS <span class="o">(</span>GNU/Linux 3.14.23-WR7.0.0.2_standard x86_64<span class="o">)</span>

<span class="k">*</span> Documentation:  https://help.ubuntu.com/
ubuntu@xr-lxc-app:~<span class="nv">$ </span>  
ubuntu@xr-lxc-app:~<span class="nv">$ </span>
ubuntu@xr-lxc-app:~<span class="nv">$ </span>

</code></pre></div>    </div>

    <p class="notice--info">To get out of the container console, issue  <strong>Ctrl+]</strong></p>
  </li>
  <li>
    <p>Use SSH to get into the container:</p>

    <p>We set the SSH port to 58822 earlier, we can use any of XR’s interface addresses to log in:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  
xr-vm_node0_RP0_CPU0:~<span class="nv">$ </span>ssh <span class="nt">-p</span> 58822 ubuntu@11.1.1.10
Warning: Permanently added <span class="s1">'[11.1.1.10]:58822'</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
ubuntu@11.1.1.10<span class="s1">'s password: 
Welcome to Ubuntu 14.04.4 LTS (GNU/Linux 3.14.23-WR7.0.0.2_standard x86_64)

* Documentation:  https://help.ubuntu.com/
Last login: Fri Jun 17 16:42:13 2016
ubuntu@xr-lxc-app:~$ 
   
</span></code></pre></div>    </div>

    <blockquote class="notice--info">

      <p>If you’d like to be able to access the container directly from your laptop, then make sure you<br />
forward the intended port (in this case 58822) to your laptop (any port of your choice), in the
Vagrantfile:</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node.vm.network "forwarded_port", guest: 58822, host: 58822
</code></pre></div>      </div>

      <p>With the above setting in the Vagrantfile, you can ssh to the container directly from your <br />
laptop using:</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -p 58822 vagrant@localhost
</code></pre></div>      </div>
    </blockquote>
  </li>
</ul>

<p class="notice--success">Perfect! Our container is up and running!</p>

<h2 id="test-your-app">Test your app!</h2>

<p>Now that we have our container up and running, let’s see how we run our app (iperf in our case).</p>

<blockquote>
<p>
Think of the LXC container as your own linux server on the router. Because we share the network namespace between the LXC and XR, all of XR's interfaces (Gig, Mgmt etc.) are available to bind to and run your applications.</p> 
<p>We can see this by issuing an ifconfig inside the running container:</p>
<div class="highlighter-rouge">
<pre class="highlight">
<code>
xr-vm_node0_RP0_CPU0:~$<mark>ssh -p 58822 ubuntu@11.1.1.10 </mark>
Warning: Permanently added '[11.1.1.10]:58822' (ECDSA) to the list of known hosts.
ubuntu@11.1.1.10's password: 
Welcome to Ubuntu 14.04.4 LTS (GNU/Linux 3.14.23-WR7.0.0.2_standard x86_64)

 * Documentation:  https://help.ubuntu.com/
Last login: Fri Jun 17 16:42:13 2016
ubuntu@xr-lxc-app:~$ 
ubuntu@xr-lxc-app:~$ 
ubuntu@xr-lxc-app:~$ 
ubuntu@xr-lxc-app:~$<mark> ifconfig </mark>
<mark>Gi0_0_0_0 Link encap:Ethernet  HWaddr 08:00:27:17:f9:a8 </mark> 
          inet addr:11.1.1.10  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe17:f9a8/64 Scope:Link
          UP RUNNING NOARP MULTICAST  MTU:1514  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1 errors:0 dropped:3 overruns:0 carrier:1
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:42 (42.0 B)

<mark>Mg0_RP0_CPU0_0 Link encap:Ethernet  HWaddr 08:00:27:13:ad:eb </mark>
          inet addr:10.0.2.15  Mask:255.255.255.0
          inet6 addr: fe80::a00:27ff:fe13:adeb/64 Scope:Link
          UP RUNNING NOARP MULTICAST  MTU:1514  Metric:1
          RX packets:89658 errors:0 dropped:0 overruns:0 frame:0
          TX packets:34130 errors:0 dropped:0 overruns:0 carrier:1
          collisions:0 txqueuelen:1000 
          RX bytes:127933763 (127.9 MB)  TX bytes:2135907 (2.1 MB)

------------------------------- snip output -----------------------------------
</code>
</pre>
</div>
</blockquote>

<h3 id="set-the-src-hint-for-application-traffic">Set the src-hint for Application traffic</h3>

<p>By default, your XR Vagrant box is set up to talk to the internet using a default route through your management port.</p>

<p class="notice--warning">If you want the router to use XR’s routing table and talk to other nodes in the topology, then you need to set the “tpa address” in XR’s configuration. This becomes the “src-hint” for all linux application traffic. The reason we use something like “loopback 0” is to make sure that the IP for any originating traffic for applications on the router is a reachable IP address across your topology.</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$<mark> vagrant port rtr | grep 22 </mark>
    22 (guest) =&gt; 2223 (host)
 57722 (guest) =&gt; 2222 (host)
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$ 
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$ 
AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$<mark> ssh -p 2223 vagrant@localhost </mark>
vagrant@localhost's password: 


RP/0/RP0/CPU0:ios#
RP/0/RP0/CPU0:ios#conf t
Fri Jun 17 17:34:45.707 UTC
RP/0/RP0/CPU0:ios(config)#<mark>int loopback 0</mark>
RP/0/RP0/CPU0:ios(config-if)#<mark>ip address 1.1.1.1/32</mark>
RP/0/RP0/CPU0:ios(config-if)#<mark>exit</mark>         
RP/0/RP0/CPU0:ios(config)#<mark>tpa address-family ipv4 update-source loopback 0</mark>
RP/0/RP0/CPU0:ios(config)#<mark>commit</mark>
Fri Jun 17 17:35:19.815 UTC
RP/0/RP0/CPU0:ios(config)#
RP/0/RP0/CPU0:ios(config)#<mark>exit</mark>
RP/0/RP0/CPU0:ios#
</code>
</pre>
</div>

<p>Let’s say we’ve set up the TPA address as shown above, you should see the following route in XR’s linux shell:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
RP/0/RP0/CPU0:ios#bash
Fri Jun 17 17:39:37.771 UTC

[xr-vm_node0_RP0_CPU0:~]$
[xr-vm_node0_RP0_CPU0:~]$ip route
<mark>default dev fwdintf  scope link  src 1.1.1.1 </mark>
10.0.2.0/24 dev Mg0_RP0_CPU0_0  proto kernel  scope link  src 10.0.2.15 
[xr-vm_node0_RP0_CPU0:~]$
</code>
</pre>
</div>

<p>So all you’ve really done using the <code class="highlighter-rouge">tpa address-family...</code>  config is to set src address for all application traffic to XR’s loopback0 address.</p>

<p class="notice--warning">The advantage of this approach is that when you use larger topologies that may include routing protocols like OSPF,BGP or even static routes, all you have to do is make loopback0 reachable and the application will be able to communicate across the entire topology. Also, this significantly reduces the routing table size in the linux environment as you can see in the output above.</p>

<h3 id="see-if-things-work">See if things work!</h3>

<p>We’re going to use an iperf-server inside our container on XR and an iperf-client running on devbox. You could reverse the client-server setup if you want.</p>

<p>Start the iperf server inside the Container on XR:</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>
xr-vm_node0_RP0_CPU0:~$<mark> ssh -p 58822 ubuntu@11.1.1.10 </mark>
ubuntu@11.1.1.10's password: 
Welcome to Ubuntu 14.04.4 LTS (GNU/Linux 3.14.23-WR7.0.0.2_standard x86_64)

 * Documentation:  https://help.ubuntu.com/
Last login: Fri Jun 17 18:09:50 2016 from 11.1.1.10
ubuntu@xr-lxc-app:~$ 
ubuntu@xr-lxc-app:~$<mark> iperf -s -u </mark>
------------------------------------------------------------
Server listening on UDP port 5001
Receiving 1470 byte datagrams
UDP buffer size: 64.0 MByte (default)
------------------------------------------------------------


</code>
</pre>
</div>

<p class="notice--warning">Keep the iperf server (started above) running, as you proceed to initiate the iperf client on the devbox.</p>

<p>Let’s make sure XR’s loopback0 is reachable from the devbox (since we’re not running routing protocols in this topology, this isn’t automatic):</p>

<div class="highlighter-rouge">
<pre class="highlight">
<code>

AKSHSHAR-M-K0DS:lxc-app-topo-bootstrap akshshar$<mark> vagrant ssh devbox</mark>
Welcome to Ubuntu 14.04.4 LTS (GNU/Linux 3.13.0-87-generic x86_64)

 * Documentation:  https://help.ubuntu.com/

---------------------------- snip output -------------------------------
vagrant@vagrant-ubuntu-trusty-64:~$ 
vagrant@vagrant-ubuntu-trusty-64:~$<mark> sudo ip route add 1.1.1.1/32 via 11.1.1.10 </mark>
vagrant@vagrant-ubuntu-trusty-64:~$ 
vagrant@vagrant-ubuntu-trusty-64:~$ ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=255 time=6.53 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=255 time=1.77 ms

</code>
</pre>
</div>

<p>Install iperf on devbox and start the iperf client there (to point to XR loopback=1.1.1.1):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant@vagrant-ubuntu-trusty-64:~<span class="nv">$ </span><span class="nb">sudo </span>apt-get install iperf
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following NEW packages will be installed:
  iperf
<span class="nt">----------------------------</span> snip output <span class="nt">-------------------------------</span>


</code></pre></div></div>

<div class="highlighter-rouge">
<pre class="highlight">
<code>

vagrant@vagrant-ubuntu-trusty-64:~$<mark> iperf -u -c 1.1.1.1 </mark>
------------------------------------------------------------
Client connecting to 1.1.1.1, UDP port 5001
Sending 1470 byte datagrams
UDP buffer size:  208 KByte (default)
------------------------------------------------------------
[  3] local 11.1.1.20 port 54284 connected with 1.1.1.1 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec
[  3] Sent 893 datagrams
[  3] Server Report:
[  3]  0.0-10.0 sec  1.25 MBytes  1.05 Mbits/sec   0.275 ms    0/  893 (0%)
vagrant@vagrant-ubuntu-trusty-64:~$ 


</code>
</pre>
</div>

<p class="notice--success">There you have it! iperf running inside an Ubuntu Container on IOS-XR. Too many steps to look up? In our next tutorial, we look at automating all of the  steps needed to bring up a container using an Ansible Playbook: <strong><a href="https://xrdocs.io/application-hosting/tutorials/2016-06-08-ios-xr-ansible-container-deployment/">IOS-XR: Ansible based LXC deployment</a></strong></p>

        
      </section>

      <footer class="page__meta">
        
        




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i>  </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#cisco" class="page__taxonomy-item" rel="tag">cisco</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#containers" class="page__taxonomy-item" rel="tag">containers</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#iosxr" class="page__taxonomy-item" rel="tag">iosxr</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#lxc" class="page__taxonomy-item" rel="tag">lxc</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#vagrant" class="page__taxonomy-item" rel="tag">vagrant</a><span class="sep">, </span>
    
      
      
      <a href="https://xrdocs.io/application-hosting/tags/#xr-toolbox" class="page__taxonomy-item" rel="tag">xr toolbox</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> </strong> <time datetime="2016-06-16T08:17:00+00:00">June 16, 2016</time></p>
        
        

      </footer>

      

<section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/" class="btn btn--twitter" title=" Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/" class="btn btn--facebook" title=" Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/" class="btn btn--google-plus" title=" Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://xrdocs.io/application-hosting/tutorials/2016-06-16-xr-toolbox-part-4-bring-your-own-container-lxc-app/" class="btn btn--linkedin" title=" LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>

    <br>
    <br>
    <br>
</section>


    </div>

    
      

<div class="page__comments">
  <h4 class="page__comments-title"></h4>
  
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        

<div class="page__footer-follow">
  <ul class="social-icons">
    
    
      <li><a href="https://twitter.com/xrdocs"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/xrdocs"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="https://xrdocs.io/application-hosting/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> </a></li>
  </ul>
</div>

<div class="page__footer-copyright">This site is maintained by Cisco Systems, Inc. employees.  <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="https://xrdocs.io/application-hosting/assets/js/main.min.js"></script>
<script src="https://xrdocs.io/application-hosting/assets/js/scrollmenu.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78256516-1', 'auto');
  ga('send', 'pageview');
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'xrdocs';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






<!-- material-scrolltop button -->
<button class="material-scrolltop" type="button"></button>

<!-- material-scrolltop plugin -->
<script src="https://xrdocs.io/application-hosting/assets/js/material-scrolltop.js"></script>

<!-- Initialize material-scrolltop with (minimal) -->
<script>
    $('body').materialScrollTop();
</script>


  </body>
</html>

